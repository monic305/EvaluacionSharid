<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Agendify - Panel Profesional</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link rel="stylesheet" th:href="@{/css/stylesprofe.css}">
</head>

<body data-theme="light">
	<!-- Custom Alert -->
	<div id="customAlert" class="custom-alert">
		<i class="fas fa-check-circle alert-icon"></i>
		<p id="alertMessage"></p>
	</div>

	<!-- Reschedule Modal -->
	<div id="rescheduleModal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h2 class="modal-title">Reprogramar Cita</h2>
				<button class="close-modal" onclick="closeModal('rescheduleModal')">&times;</button>
			</div>
			<div class="form-group">
				<label>Nueva Fecha</label>
				<input type="date" id="newAppointmentDate" min="">
			</div>
			<div class="form-group">
				<label>Nueva Hora</label>
				<input type="time" id="newAppointmentTime">
			</div>
			<div class="form-group">
				<label>Notas (opcional)</label>
				<textarea id="rescheduleNotes" rows="3" placeholder="Motivo de la reprogramaci贸n..."></textarea>
			</div>
			<button class="btn btn-primary" onclick="confirmReschedule()">Confirmar Reprogramaci贸n</button>
		</div>
	</div>

	<!-- Service Modal -->
	<div id="serviceModal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h2 class="modal-title" id="serviceModalTitle">Crear Servicio</h2>
				<button class="close-modal" onclick="closeModal('serviceModal')">&times;</button>
			</div>
			<div class="form-group">
				<label>Nombre del Servicio</label>
				<input type="text" id="serviceName" placeholder="Ej: Corte de Cabello">
			</div>
			<div class="form-group">
				<label>Descripci贸n</label>
				<textarea id="serviceDescription" rows="3" placeholder="Describe tu servicio..."></textarea>
			</div>
			<div class="form-group">
				<label>Precio</label>
				<input type="number" id="servicePrice" placeholder="Ej: 30000">
			</div>
			<div class="form-group">
				<label>Duraci贸n</label>
				<input type="text" id="serviceDuration" placeholder="Ej: 60 min">
			</div>
			<button class="btn btn-primary" onclick="saveService()">Guardar Servicio</button>
		</div>
	</div>

	<!-- Navigation -->
	<nav>
		<div class="nav-container">
			<div class="logo" onclick="showSection('dashboard')">
				<i class="fas fa-scissors"></i> Agendify Beauty
			</div>
			<ul class="nav-links">
				<li><a onclick="showSection('dashboard')">Dashboard</a></li>
				<li><a onclick="showSection('appointments')">Citas</a></li>
				<li><a onclick="showSection('services')">Servicios</a></li>
				<li><a onclick="showSection('profile')">Mi Perfil</a></li>
				<li>
					<button class="theme-toggle" onclick="toggleTheme()">
						<i class="fas fa-moon" id="themeIcon"></i>
					</button>
				</li>
				<li class="user-menu">
					<div class="user-avatar" id="userAvatar" onclick="toggleUserDropdown()">
						<span
							th:text="${nombreUsuario != null ? nombreUsuario.substring(0,1).toUpperCase() : 'P'}">P</span>
					</div>
					<div class="user-dropdown" id="userDropdown">
						<a th:href="@{/logout}">Cerrar Sesi贸n</a>
					</div>
				</li>
			</ul>
		</div>
	</nav>

	<!-- Hidden data for JavaScript -->
	<input type="hidden" id="usuarioId" th:value="${usuarioId}">
	<input type="hidden" id="profesionalId" th:value="${profesionalId}">
	<input type="hidden" id="nombreUsuario" th:value="${nombreUsuario}">

	<!-- Main Content -->
	<main>
		<!-- Dashboard Section -->
		<section id="dashboard" class="section active">
			<div class="dashboard-header">
				<h1>Panel Profesional</h1>
				<p>Bienvenido de nuevo, <span th:text="${nombreUsuario}">Profesional</span></p>
			</div>

			<!-- Stats -->
			<div class="stats-container">
				<div class="stat-card">
					<div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
					<div class="stat-number" id="citasHoy">0</div>
					<div class="stat-label">Citas Hoy</div>
				</div>
				<div class="stat-card">
					<div class="stat-icon"><i class="fas fa-users"></i></div>
					<div class="stat-number" id="citasSemana">0</div>
					<div class="stat-label">Citas Esta Semana</div>
				</div>
				<div class="stat-card">
					<div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
					<div class="stat-number" id="ingresosMes">$0</div>
					<div class="stat-label">Ingresos del Mes</div>
				</div>
				<div class="stat-card">
					<div class="stat-icon"><i class="fas fa-star"></i></div>
					<div class="stat-number">4.8</div>
					<div class="stat-label">Calificaci贸n</div>
				</div>
			</div>

			<div class="panel-grid">
				<div class="panel-card">
					<h3><i class="fas fa-calendar-day"></i> Pr贸ximas Citas</h3>
					<div id="professionalAppointments"></div>
				</div>
			</div>
		</section>

		<!-- Appointments Section -->
		<section id="appointments" class="section">
			<h1 class="section-title">Gesti贸n de Citas</h1>

			<div class="panel-grid">
				<div class="panel-card">
					<h3><i class="fas fa-calendar-alt"></i> Tus Citas</h3>
					<div id="citasProximasList"></div>
				</div>
			</div>
		</section>

		<!-- Services Section -->
		<section id="services" class="section">
			<h1 class="section-title">Mis Servicios</h1>

			<div class="panel-grid">
				<div class="panel-card">
					<h3><i class="fas fa-concierge-bell"></i> Servicios Ofrecidos</h3>
					<div class="services-management" id="serviciosList"></div>
					<button class="btn-full" style="margin-top: 1.5rem;" onclick="openServiceModal()">Agregar Nuevo
						Servicio</button>
				</div>
			</div>
		</section>

		<!-- Profile Section -->
		<section id="profile" class="section">
			<h1 class="section-title">Mi Perfil</h1>
			<div class="profile-container">
				<div class="profile-header">
					<div class="profile-avatar" id="profileAvatar"><i class="fas fa-user-md"></i></div>
					<h2 id="profileName" th:text="${nombreUsuario}">Profesional</h2>
					<p>Estilista Profesional</p>
				</div>

				<form th:action="@{/profesional/actualizar-perfil}" method="post">
					<input type="hidden" name="usuarioId" th:value="${usuarioId}">
					<input type="hidden" name="profesionalId" th:value="${profesionalId}">

					<div class="form-group">
						<label>Nombre completo</label>
						<input type="text" id="profileNameInput" name="nombre" placeholder="Tu nombre"
							th:value="${nombreUsuario}" required>
					</div>
					<div class="form-group">
						<label>Email</label>
						<input type="email" id="profileEmail" name="email" placeholder="tu@email.com" required>
					</div>
					<div class="form-group">
						<label>Tel茅fono</label>
						<input type="tel" id="profilePhone" name="telefono" placeholder="+57 300 123 4567" required>
					</div>
					<div class="form-group">
						<label>Especialidad</label>
						<input type="text" id="profileSpecialty" name="especialidad" placeholder="Tu especialidad"
							required>
					</div>
					<button type="submit" class="btn-full">Actualizar Perfil</button>
				</form>

				<a th:href="@{/logout}" class="btn-full logout-btn"
					style="display: inline-block; text-align: center; text-decoration: none;">Cerrar Sesi贸n</a>

				<form th:action="@{/profesional/eliminar-cuenta}" method="post"
					onsubmit="return confirm('驴Est谩s seguro de eliminar tu cuenta?');">
					<input type="hidden" name="usuarioId" th:value="${usuarioId}">
					<input type="hidden" name="profesionalId" th:value="${profesionalId}">
					<button type="submit" class="btn-full delete-account-btn">Eliminar Cuenta</button>
				</form>
			</div>
		</section>
	</main>
	<!-- Footer -->
	<footer>
		<div class="footer-content">
			<div class="logo" style="font-size: 2rem; margin-bottom: 1rem;"><i class="fas fa-scissors"></i> Agendify
				Beauty</div>
			<p>Tu belleza es nuestra prioridad</p>

			<div class="footer-grid">
				<div class="footer-section">
					<h3>Navegaci贸n</h3>
					<ul>
						<li><a onclick="showSection('dashboard')">Dashboard</a></li>
						<li><a onclick="showSection('appointments')">Citas</a></li>
						<li><a onclick="showSection('schedule')">Horario</a></li>
						<li><a onclick="showSection('services')">Servicios</a></li>
						<li><a onclick="showSection('profile')">Mi Perfil</a></li>
					</ul>
				</div>
				<div class="footer-section">
					<h3>Servicios Populares</h3>
					<ul>
						<li><a>Corte de Cabello</a></li>
						<li><a>Coloraci贸n</a></li>
						<li><a>Tratamientos</a></li>
						<li><a>Manicure & Pedicure</a></li>
					</ul>
				</div>
				<div class="footer-section">
					<h3>Legal</h3>
					<ul>
						<li><a href="#">T茅rminos y Condiciones</a></li>
						<li><a href="#">Pol铆tica de Privacidad</a></li>
						<li><a href="#">Pol铆tica de Cancelaci贸n</a></li>
						<li><a href="#">Preguntas Frecuentes</a></li>
					</ul>
				</div>
				<div class="footer-section">
					<h3>Contacto</h3>
					<div class="contact-info">
						<p><i class="fas fa-map-marker-alt"></i> Fusagasug谩, Cundinamarca</p>
						<p><i class="fas fa-phone"></i> +57 300 123 4567</p>
						<p><i class="fas fa-envelope"></i> info@agendifybeauty.com</p>
						<p><i class="fas fa-clock"></i> Lun-Sab: 9AM-7PM</p>
					</div>
				</div>
			</div>

			<div class="social-links">
				<a href="#"><i class="fab fa-facebook-f"></i></a>
				<a href="#"><i class="fab fa-instagram"></i></a>
				<a href="#"><i class="fab fa-whatsapp"></i></a>
				<a href="#"><i class="fab fa-tiktok"></i></a>
				<a href="#"><i class="fab fa-youtube"></i></a>
			</div>

			<p
				style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.3); font-size: 0.9rem;">
				&copy; 2025 Agendify Beauty. Todos los derechos reservados. | Hecho con  para ti
			</p>
		</div>
	</footer>
	<script th:src="@{/js/ScripsProfesio.js}"></script>
	<script th:inline="javascript">
		const profesionalId = /*[[${profesionalId}]]*/ null;
		let currentAppointmentId = null;
		let currentServiceId = null;
		let isEditingService = false;

		async function loadAppointments() {
			try {
				const response = await fetch('/profesional/citas');
				const citas = await response.json();

				const container = document.getElementById('citasProximasList');
				const dashboardContainer = document.getElementById('professionalAppointments');

				container.innerHTML = '';
				dashboardContainer.innerHTML = '';

				let citasHoy = 0;
				let citasSemana = 0;
				const hoy = new Date().toDateString();

				citas.forEach(cita => {
					if (cita.estado !== 'completada') {
						const citaDate = new Date(cita.fechaHora).toDateString();
						if (citaDate === hoy) citasHoy++;
						citasSemana++;

						const citaElement = createAppointmentElement(cita);
						container.appendChild(citaElement);
						dashboardContainer.appendChild(citaElement.cloneNode(true));
					}
				});

				document.getElementById('citasHoy').textContent = citasHoy;
				document.getElementById('citasSemana').textContent = citasSemana;
			} catch (error) {
				console.error('Error cargando citas:', error);
			}
		}

		function createAppointmentElement(cita) {
			const div = document.createElement('div');
			div.className = 'appointment-item';

			const fecha = new Date(cita.fechaHora);
			const fechaFormato = fecha.toLocaleDateString();
			const horaFormato = fecha.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});

			let statusText = cita.estado === 'pendiente' ? 'Pendiente' : 'Confirmada';
			let statusColor = cita.estado === 'pendiente' ? '#f59e0b' : '#10b981';

			div.innerHTML = `
	              <h4>${cita.usuario.nombre}</h4>
	              <p><strong>Servicio:</strong> ${cita.servicio.nombre}</p>
	              <p><strong>Fecha:</strong> ${fechaFormato}</p>
	              <p><strong>Hora:</strong> ${horaFormato}</p>
	              <p><strong>Estado:</strong> <span style="color: ${statusColor}">${statusText}</span></p>
	              <div class="appointment-actions">
	                  <button class="btn btn-danger" onclick="cancelarCita(${cita.id})">Cancelar</button>
	                  <button class="btn btn-warning" onclick="openRescheduleModal(${cita.id})">Reprogramar</button>
	                  <button class="btn btn-success" onclick="finalizarCita(${cita.id})">Finalizar</button>
	              </div>
	          `;

			return div;
		}

		async function cancelarCita(citaId) {
			if (!confirm('驴Est谩s seguro de que deseas cancelar esta cita?')) return;

			try {
				const formData = new URLSearchParams();
				formData.append('citaId', citaId);

				const response = await fetch('/profesional/cancelar-cita', {
					method: 'POST',
					headers: {'Content-Type': 'application/x-www-form-urlencoded'},
					body: formData
				});

				const result = await response.text();
				if (result === 'success') {
					showAlert('Cita cancelada exitosamente', 'success');
					loadAppointments();
				}
			} catch (error) {
				console.error('Error:', error);
			}
		}

		function openRescheduleModal(citaId) {
			currentAppointmentId = citaId;
			openModal('rescheduleModal');

			const today = new Date().toISOString().split('T')[0];
			document.getElementById('newAppointmentDate').min = today;
			document.getElementById('newAppointmentDate').value = today;
		}

		async function confirmReschedule() {
			const fecha = document.getElementById('newAppointmentDate').value;
			const hora = document.getElementById('newAppointmentTime').value;

			if (!fecha || !hora) {
				showAlert('Por favor completa todos los campos', 'error');
				return;
			}

			try {
				const formData = new URLSearchParams();
				formData.append('citaId', currentAppointmentId);
				formData.append('fecha', fecha);
				formData.append('hora', hora);

				const response = await fetch('/profesional/reprogramar-cita', {
					method: 'POST',
					headers: {'Content-Type': 'application/x-www-form-urlencoded'},
					body: formData
				});

				const result = await response.text();
				if (result === 'success') {
					showAlert(`Cita reprogramada para el ${fecha} a las ${hora}`, 'success');
					closeModal('rescheduleModal');
					document.getElementById('rescheduleNotes').value = '';
					loadAppointments();
				}
			} catch (error) {
				console.error('Error:', error);
			}
		}

		async function finalizarCita(citaId) {
			try {
				const formData = new URLSearchParams();
				formData.append('citaId', citaId);

				const response = await fetch('/profesional/finalizar-cita', {
					method: 'POST',
					headers: {'Content-Type': 'application/x-www-form-urlencoded'},
					body: formData
				});

				const result = await response.text();
				if (result === 'success') {
					showAlert('Cita finalizada exitosamente', 'success');
					loadAppointments();
				}
			} catch (error) {
				console.error('Error:', error);
			}
		}

		async function loadServices() {
			try {
				const response = await fetch('/profesional/servicios');
				const servicios = await response.json();

				const container = document.getElementById('serviciosList');
				container.innerHTML = '';

				servicios.forEach(servicio => {
					const div = document.createElement('div');
					div.className = 'service-item';
					div.innerHTML = `
	                      <div class="service-info">
	                          <h4>${servicio.nombre}</h4>
	                          <p>${servicio.descripcion}</p>
	                          <p><strong>Precio:</strong> $${servicio.precio.toLocaleString()} | <strong>Duraci贸n:</strong> ${servicio.duracion}</p>
	                      </div>
	                      <div class="service-actions">
	                          <button class="btn btn-primary" onclick="editService(${servicio.id})">Editar</button>
	                          <button class="btn btn-danger" onclick="deleteService(${servicio.id})">Eliminar</button>
	                      </div>
	                  `;
					container.appendChild(div);
				});
			} catch (error) {
				console.error('Error cargando servicios:', error);
			}
		}

		function openServiceModal(serviceId = null) {
			isEditingService = serviceId !== null;
			currentServiceId = serviceId;

			const modalTitle = document.getElementById('serviceModalTitle');
			modalTitle.textContent = isEditingService ? 'Editar Servicio' : 'Crear Servicio';

			if (!isEditingService) {
				document.getElementById('serviceName').value = '';
				document.getElementById('serviceDescription').value = '';
				document.getElementById('servicePrice').value = '';
				document.getElementById('serviceDuration').value = '';
			}

			openModal('serviceModal');
		}

		async function editService(id) {
			try {
				const response = await fetch('/profesional/servicios');
				const servicios = await response.json();
				const servicio = servicios.find(s => s.id === id);

				if (servicio) {
					document.getElementById('serviceName').value = servicio.nombre;
					document.getElementById('serviceDescription').value = servicio.descripcion;
					document.getElementById('servicePrice').value = servicio.precio;
					document.getElementById('serviceDuration').value = servicio.duracion;
					openServiceModal(id);
				}
			} catch (error) {
				console.error('Error:', error);
			}
		}

		async function deleteService(id) {
			if (!confirm('驴Est谩s seguro de que deseas eliminar este servicio?')) return;

			try {
				const formData = new URLSearchParams();
				formData.append('id', id);

				const response = await fetch('/profesional/eliminar-servicio', {
					method: 'POST',
					headers: {'Content-Type': 'application/x-www-form-urlencoded'},
					body: formData
				});

				const result = await response.text();
				if (result === 'success') {
					showAlert('Servicio eliminado exitosamente', 'success');
					loadServices();
				}
			} catch (error) {
				console.error('Error:', error);
			}
		}

		async function saveService() {
			const nombre = document.getElementById('serviceName').value;
			const descripcion = document.getElementById('serviceDescription').value;
			const precio = document.getElementById('servicePrice').value;
			const duracion = document.getElementById('serviceDuration').value;

			if (!nombre || !descripcion || !precio || !duracion) {
				showAlert('Por favor completa todos los campos', 'error');
				return;
			}

			try {
				const formData = new URLSearchParams();
				formData.append('nombre', nombre);
				formData.append('descripcion', descripcion);
				formData.append('precio', precio);
				formData.append('duracion', duracion);

				const url = isEditingService ? '/profesional/actualizar-servicio' : '/profesional/crear-servicio';
				if (isEditingService) {
					formData.append('id', currentServiceId);
				}

				const response = await fetch(url, {
					method: 'POST',
					headers: {'Content-Type': 'application/x-www-form-urlencoded'},
					body: formData
				});

				const result = await response.text();
				if (result === 'success') {
					showAlert(`Servicio ${isEditingService ? 'actualizado' : 'creado'} exitosamente`, 'success');
					closeModal('serviceModal');
					loadServices();
				}
			} catch (error) {
				console.error('Error:', error);
			}
		}

		document.addEventListener('DOMContentLoaded', function () {
			loadAppointments();
			loadServices();
		});
	</script>
</body>

</html>